var $=(t,h,l)=>new Promise((g,j)=>{var C=s=>{try{b(l.next(s))}catch(f){j(f)}},y=s=>{try{b(l.throw(s))}catch(f){j(f)}},b=s=>s.done?g(s.value):Promise.resolve(s.value).then(C,y);b((l=l.apply(t,h)).next())});import{b as ee,d as te,e as re,u as ae,r as u,j as e,C as se,ai as G,U as H,z as le,O as K,a6 as de,y as ie}from"./index-BXN-gaEy.js";import{C as ne}from"./ConfirmationModal-CVK0Y9X0.js";import"./vendor-firebase-CLtQg3ae.js";const T=({title:t,value:h,icon:l})=>e.jsx("div",{className:"bg-light-surface dark:bg-dark-surface p-5 rounded-lg shadow-md border border-light-border dark:border-dark-border",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-3 bg-primary/10 text-primary rounded-lg mr-4",children:l}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-light-subtle dark:text-dark-subtle",children:t}),e.jsx("p",{className:"text-3xl font-bold text-light-text dark:text-dark-text",children:h})]})]})}),ue=()=>{const{currentUser:t}=ee(),{users:h,teachers:l,sales:g,handleRequestAffiliateWithdrawal:j,processMonthlyPayouts:C}=te(),{addToast:y}=re(),{handleNavigate:b,financialSettings:s}=ae(),[f,I]=u.useState(!1),[M,A]=u.useState(""),[E,F]=u.useState(!0),W=t?`${window.location.origin}/?ref=${t.referralCode}`:"",L=t?`${window.location.origin}/?teacherRef=${t.referralCode}`:"";u.useEffect(()=>{$(void 0,null,function*(){if(t!=null&&t.id){if(F(!0),t.role==="teacher"||t.role==="student"||t.role==="tuition_institute"){const o=t.role==="tuition_institute"?"institute":t.role;yield C(o,t.id)}F(!1)}})},[t==null?void 0:t.id,t==null?void 0:t.role]);const D=r=>{navigator.clipboard.writeText(r).then(()=>y("Copied to clipboard!","success")).catch(()=>y("Failed to copy.","error"))},d=(t==null?void 0:t.referralBalance)||{total:0,available:0},x=u.useMemo(()=>{if(!t)return null;const r=h.filter(a=>a.referrerId===t.id),o=r.filter(a=>a.role==="student"),P=r.filter(a=>a.role==="teacher"),_=new Set(P.map(a=>a.id)),S=l.filter(a=>a.registrationStatus==="approved"&&_.has(a.userId)),B=new Date,U=new Date(B.getFullYear(),B.getMonth(),1),p=g.filter(a=>S.some(c=>c.id===a.teacherId)&&a.status==="completed"&&new Date(a.saleDate)>=U).reduce((a,c)=>{const N=l.find(k=>k.id===c.teacherId);if(!N||(t.monthlyReferralEarnings||[]).filter(k=>k.status==="processed").reduce((k,Z)=>k+Z.earnings,0)>=s.referralMaxEarning)return a;const n=c.totalAmount+c.amountPaidFromBalance,v=n*(N.commissionRate/100),O=n*s.referralGatewayFeeRate,R=n*s.referralPlatformCostRate,Y=v-O-R;return a+(Y>0?Y:0)},0);let w=s.referralBaseRate;p>=s.referralTier3Threshold?w=s.referralTier3Rate:p>=s.referralTier2Threshold?w=s.referralTier2Rate:p>=s.referralTier1Threshold&&(w=s.referralTier1Rate);const X=p*w,Q=S.map(a=>{const c=g.filter(m=>m.teacherId===a.id&&m.status==="completed").reduce((m,n)=>{const v=n.totalAmount+n.amountPaidFromBalance,R=v*(a.commissionRate/100)-v*(s.referralGatewayFeeRate+s.referralPlatformCostRate);return m+(R>0?R:0)},0),N=(t.monthlyReferralEarnings||[]).reduce((m,n)=>m+n.earnings,0);return{teacher:a,totalNetPlatformIncome:c,totalEarningsFromTeacher:N}});return{referredStudents:o,referredTeachers:S,monthlyNetPlatformIncome:p,estimatedMonthlyEarnings:X,earningsPerTeacher:Q}},[t,h,l,g,s]);if(!t)return e.jsx("div",{className:"text-center p-8",children:"Please log in to view your referral dashboard."});const J=()=>{const r=parseFloat(M);r>0&&d.available>=r&&j(r),I(!1),A("")},i=new Intl.NumberFormat("en-LK",{style:"currency",currency:"LKR",minimumFractionDigits:0}),z=["January","February","March","April","May","June","July","August","September","October","November","December"],q=u.useMemo(()=>[...t.withdrawalHistory||[]].sort((r,o)=>new Date(o.requestedAt).getTime()-new Date(r.requestedAt).getTime()),[t.withdrawalHistory]),V=({status:r})=>{const o={pending:"bg-yellow-100 text-yellow-800 dark:bg-yellow-800/50 dark:text-yellow-300",completed:"bg-green-100 text-green-800 dark:bg-green-800/50 dark:text-green-300",failed:"bg-red-100 text-red-800 dark:bg-red-800/50 dark:text-red-300"},P={pending:e.jsx(ie,{className:"w-4 h-4 mr-1.5"}),completed:e.jsx(K,{className:"w-4 h-4 mr-1.5"}),failed:e.jsx(de,{className:"w-4 h-4 mr-1.5"})};return e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${o[r]}`,children:[P[r],r.charAt(0).toUpperCase()+r.slice(1)]})};return e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-slideInUp",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("button",{onClick:()=>b({name:"home"}),className:"flex items-center space-x-2 text-sm font-medium text-primary hover:text-primary-dark",children:[e.jsx(se,{className:"h-5 w-5"}),e.jsx("span",{children:"Back to Home"})]})}),e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-8 rounded-lg shadow-md",children:[e.jsx("h1",{className:"text-3xl font-bold text-center",children:"Your Referral Program"}),e.jsx("p",{className:"mt-2 text-light-subtle dark:text-dark-subtle text-center",children:"Share your links and earn commissions!"}),e.jsxs("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"Invite a Student"}),e.jsx("p",{className:"mt-1 text-sm text-light-subtle dark:text-dark-subtle",children:"Share this link with students. You'll earn from their top-ups. (Feature coming soon)"}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"font-semibold text-sm",children:"Your Student Referral Link"}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("input",{type:"text",readOnly:!0,value:W,className:"w-full text-sm p-2 border rounded-md bg-light-background dark:bg-dark-background text-light-subtle dark:text-dark-subtle"}),e.jsx("button",{onClick:()=>D(W),className:"p-2 bg-primary text-white rounded-md hover:bg-primary-dark",children:e.jsx(G,{className:"w-5 h-5"})})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"Invite a Teacher"}),e.jsx("p",{className:"mt-1 text-sm text-light-subtle dark:text-dark-subtle",children:"Share this link with educators. You'll earn commissions based on the platform income they generate."}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"font-semibold text-sm",children:"Your Teacher Referral Link"}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx("input",{type:"text",readOnly:!0,value:L,className:"w-full text-sm p-2 border rounded-md bg-light-background dark:bg-dark-background text-light-subtle dark:text-dark-subtle"}),e.jsx("button",{onClick:()=>D(L),className:"p-2 bg-primary text-white rounded-md hover:bg-primary-dark",children:e.jsx(G,{className:"w-5 h-5"})})]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8",children:[e.jsx(T,{title:"Referred Students",value:(x==null?void 0:x.referredStudents.length)||0,icon:e.jsx(H,{className:"w-7 h-7"})}),e.jsx(T,{title:"Referred Teachers",value:(x==null?void 0:x.referredTeachers.length)||0,icon:e.jsx(H,{className:"w-7 h-7"})}),e.jsx(T,{title:"Total Referral Earnings",value:i.format(d.total),icon:e.jsx(le,{className:"w-7 h-7"})}),e.jsx(T,{title:"Available for Withdrawal",value:i.format(d.available),icon:e.jsx(K,{className:"w-7 h-7"})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-8",children:[e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Monthly Earnings History"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-light-border dark:divide-dark-border text-sm",children:[e.jsx("thead",{className:"bg-light-background dark:bg-dark-background",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-light-subtle dark:text-dark-subtle",children:"Month"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium uppercase tracking-wider text-light-subtle dark:text-dark-subtle",children:"Net Income Generated"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium uppercase tracking-wider text-light-subtle dark:text-dark-subtle",children:"Your Earnings"}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-medium uppercase tracking-wider text-light-subtle dark:text-dark-subtle",children:"Status"})]})}),e.jsx("tbody",{className:"divide-y divide-light-border dark:divide-dark-border",children:(t.monthlyReferralEarnings||[]).map(r=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-3 py-3 whitespace-nowrap font-semibold text-light-text dark:text-dark-text",children:[z[r.month]," ",r.year]}),e.jsx("td",{className:"px-3 py-3 whitespace-nowrap text-right text-light-text dark:text-dark-text",children:i.format(r.netPlatformIncome)}),e.jsx("td",{className:"px-3 py-3 whitespace-nowrap text-right font-bold text-green-600 dark:text-green-400",children:i.format(r.earnings)}),e.jsx("td",{className:"px-3 py-3 whitespace-nowrap text-center capitalize text-light-text dark:text-dark-text",children:r.status})]},`${r.year}-${r.month}`))})]})})]}),e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Withdrawal History"}),q.length>0?e.jsx("div",{className:"overflow-x-auto max-h-60",children:e.jsxs("table",{className:"min-w-full divide-y divide-light-border dark:divide-dark-border text-sm",children:[e.jsx("thead",{className:"bg-light-background dark:bg-dark-background sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium uppercase tracking-wider text-light-subtle dark:text-dark-subtle",children:"Requested"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium uppercase tracking-wider text-light-subtle dark:text-dark-subtle",children:"Amount"}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-medium uppercase tracking-wider text-light-subtle dark:text-dark-subtle",children:"Status"})]})}),e.jsx("tbody",{className:"divide-y divide-light-border dark:divide-dark-border",children:q.map(r=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-3 whitespace-nowrap",children:new Date(r.requestedAt).toLocaleDateString()}),e.jsx("td",{className:"px-3 py-3 whitespace-nowrap text-right font-semibold",children:i.format(r.amount)}),e.jsx("td",{className:"px-3 py-3 whitespace-nowrap text-center",children:e.jsx(V,{status:r.status})})]},r.id))})]})}):e.jsx("p",{className:"text-center py-8 text-light-subtle dark:text-dark-subtle",children:"No withdrawal requests yet."})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md sticky top-24",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Withdraw Referral Earnings"}),e.jsxs("div",{className:"text-center bg-light-background dark:bg-dark-background p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-light-subtle dark:text-dark-subtle",children:"Available to Withdraw"}),e.jsx("p",{className:"text-4xl font-bold text-primary",children:i.format(d.available)})]}),e.jsx("button",{onClick:()=>I(!0),disabled:d.available<1e4||E,className:"mt-4 w-full bg-primary text-white font-bold py-3 rounded-md hover:bg-primary-dark transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",children:E?"Processing Payouts...":"Request Withdrawal"}),d.available<1e4&&e.jsxs("p",{className:"text-center text-xs text-light-subtle dark:text-dark-subtle mt-2",children:["A minimum balance of ",i.format(1e4)," is required to withdraw."]})]})})]}),e.jsxs("div",{className:"mt-8 text-left text-xs text-light-subtle dark:text-dark-subtle bg-light-background dark:bg-dark-background p-4 rounded-lg border border-light-border dark:border-dark-border",children:[e.jsx("h4",{className:"font-bold text-sm text-light-text dark:text-dark-text mb-2",children:"Program Rules & Conditions"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1",children:[e.jsx("li",{children:"Earn commissions based on the Net Platform Income generated by your referred teachers."}),e.jsx("li",{children:"Commissions are tiered: Tier 1 (< 100k LKR) earns 4%, Tier 2 (< 300k) earns 5%, Tier 3 (< 1M) earns 6%, Tier 4 (â‰¥ 1M) earns 7%. Tiers are calculated based on the total NPI generated by all your referred teachers within a calendar month."}),e.jsx("li",{children:"Your total lifetime earnings from each individually referred teacher are capped at 100,000 LKR."}),e.jsx("li",{children:'Monthly earnings are automatically processed and moved to your "Available for Withdrawal" balance on the 16th of the following month.'}),e.jsx("li",{children:"Withdrawals require a minimum available balance of 10,000 LKR."})]})]}),e.jsx(ne,{isOpen:f,onClose:()=>I(!1),onConfirm:J,title:"Request Withdrawal",message:`Enter amount to withdraw from your available balance of ${i.format(d.available)}.`,confirmText:"Submit Request",children:e.jsx("input",{type:"number",value:M,onChange:r=>A(r.target.value),max:d.available,className:"w-full mt-4 p-2 border rounded-md text-light-text dark:text-dark-text bg-light-background dark:bg-dark-background border-light-border dark:border-dark-border",placeholder:"Amount (e.g., 10000)"})})]})};export{ue as default};
