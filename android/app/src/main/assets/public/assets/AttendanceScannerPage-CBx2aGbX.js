var S=(f,h,n)=>new Promise((u,a)=>{var b=r=>{try{l(n.next(r))}catch(c){a(c)}},d=r=>{try{l(n.throw(r))}catch(c){a(c)}},l=r=>r.done?u(r.value):Promise.resolve(r.value).then(b,d);l((n=n.apply(f,h)).next())});import{d as E,r as i,j as e,F as I,l as F,O as L,a6 as O,z as _,u as T,C as U,an as B}from"./index-BXN-gaEy.js";import"./vendor-firebase-CLtQg3ae.js";const $=({isOpen:f,onClose:h,student:n,classInfo:u,sale:a})=>{const{markAttendance:b,recordManualPayment:d}=E(),[l,r]=i.useState(!1),[c,p]=i.useState(!!a),N=new Intl.NumberFormat("en-LK",{style:"currency",currency:"LKR"}),v=()=>S(void 0,null,function*(){r(!0);const x=c?(a==null?void 0:a.paymentMethod)==="manual_at_venue"?"paid_at_venue":"paid":"unpaid",g=a==null?void 0:a.id;yield b(u.id,n,x,g),r(!1),h()}),y=()=>S(void 0,null,function*(){r(!0);const x=yield d(u,n);x&&(yield b(u.id,n,"paid_at_venue",x.id),p(!0)),r(!1),h()});return e.jsx(I,{isOpen:f,onClose:h,title:"Student Attendance",children:e.jsxs("div",{className:"text-center",children:[e.jsx("img",{src:F(n.avatar,96,96),alt:n.firstName,className:"w-24 h-24 rounded-full mx-auto shadow-lg border-2 border-primary"}),e.jsxs("h2",{className:"text-2xl font-bold mt-4",children:[n.firstName," ",n.lastName]}),e.jsx("p",{className:"text-sm text-light-subtle dark:text-dark-subtle",children:n.id}),e.jsxs("div",{className:`mt-6 p-4 rounded-lg border ${c?"bg-green-50 dark:bg-green-900/30 border-green-500":"bg-red-50 dark:bg-red-900/30 border-red-500"}`,children:[e.jsxs("div",{className:"flex items-center justify-center",children:[c?e.jsx(L,{className:"w-6 h-6 text-green-500"}):e.jsx(O,{className:"w-6 h-6 text-red-500"}),e.jsx("p",{className:`ml-2 font-semibold text-lg ${c?"text-green-700 dark:text-green-300":"text-red-700 dark:text-red-300"}`,children:c?"Payment Confirmed":"Not Enrolled / Not Paid"})]}),c&&a&&e.jsxs("div",{className:"text-xs text-green-600 dark:text-green-400 mt-2",children:[e.jsxs("p",{children:["Paid on: ",new Date(a.saleDate).toLocaleDateString()]}),e.jsxs("p",{children:["Amount: ",N.format(a.totalAmount+a.amountPaidFromBalance)]})]})]}),e.jsxs("div",{className:"mt-8 space-y-3",children:[e.jsx("button",{onClick:v,disabled:l,className:"w-full bg-primary text-white font-bold py-3 rounded-md hover:bg-primary-dark transition-colors disabled:opacity-50",children:l?"Processing...":"Mark Attendance"}),!c&&u.paymentMethod==="manual"&&u.fee>0&&e.jsxs("button",{onClick:y,disabled:l,className:"w-full flex items-center justify-center bg-green-600 text-white font-bold py-3 rounded-md hover:bg-green-700 transition-colors disabled:opacity-50",children:[e.jsx(_,{className:"w-5 h-5 mr-2"}),l?"Recording...":`Record Payment (${N.format(u.fee)})`]})]})]})})},K=({classId:f,eventId:h})=>{const{users:n,sales:u,teachers:a}=E(),{handleBack:b}=T(),d=i.useRef(null),l=i.useRef(null),r=i.useRef(null),c=i.useRef(null),[p,N]=i.useState(null),[v,y]=i.useState(!1),[x,g]=i.useState(""),[w,A]=i.useState(!0),m=i.useMemo(()=>{if(!f)return null;for(const o of a){const t=o.individualClasses.find(s=>s.id===f);if(t)return t}return null},[a,f]),D=i.useMemo(()=>!p||!m?null:u.find(o=>o.studentId===p.id&&o.itemId===m.id&&o.itemType==="class"&&o.status==="completed"),[u,p,m]),P=i.useCallback(()=>{y(!1),N(null)},[]),R=i.useCallback(o=>{const t=n.find(s=>s.id===o);t?(N(t),y(!0)):(g(`Student ID "${o}" not found.`),setTimeout(()=>{g("")},3e3))},[n]);return i.useEffect(()=>{let o=!1;const t=()=>{if(!o){if(d.current&&d.current.readyState===d.current.HAVE_ENOUGH_DATA&&l.current){const s=l.current,k=d.current,j=s.getContext("2d");if(k.videoWidth>0){s.height=k.videoHeight,s.width=k.videoWidth,j==null||j.drawImage(k,0,0,s.width,s.height);const C=j==null?void 0:j.getImageData(0,0,s.width,s.height);if(C){const M=jsQR(C.data,C.width,C.height,{inversionAttempts:"dontInvert"});if(M&&M.data){R(M.data);return}}}}r.current=requestAnimationFrame(t)}};return!v&&!w&&(r.current=requestAnimationFrame(t)),()=>{o=!0,r.current&&cancelAnimationFrame(r.current)}},[v,w,R]),i.useEffect(()=>(S(void 0,null,function*(){if(g(""),A(!0),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){g("Camera access is not supported by this browser."),A(!1);return}try{const t=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});c.current=t,d.current&&(d.current.srcObject=t,d.current.setAttribute("playsinline","true"),yield d.current.play())}catch(t){console.error("Camera Error:",t);let s="Could not access camera. Please grant permission and try again.";t instanceof DOMException&&(t.name==="NotAllowedError"?s="Camera permission was denied. Please enable it in your browser settings.":t.name==="NotFoundError"?s="No camera found on this device.":t.name==="NotReadableError"&&(s="The camera is currently in use by another application.")),g(s)}finally{A(!1)}}),()=>{c.current&&c.current.getTracks().forEach(t=>t.stop())}),[]),!m&&!h?e.jsx("div",{className:"p-8 text-center",children:"No class or event specified."}):h&&!m?e.jsx("div",{className:"p-8 text-center",children:f?"Class not found.":"Event attendance scanning is not yet supported."}):m?e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-slideInUp",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:b,className:"flex items-center space-x-2 text-sm font-medium text-primary hover:text-primary-dark transition-colors",children:[e.jsx(U,{className:"h-5 w-5"}),e.jsx("span",{children:"Back to Dashboard"})]})}),e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Attendance Scanner"}),e.jsx("p",{className:"text-lg text-primary",children:m.title}),e.jsxs("div",{className:"mt-4 relative w-full aspect-video bg-gray-900 rounded-lg overflow-hidden flex items-center justify-center text-white",children:[e.jsx("video",{ref:d,className:"w-full h-full object-cover",muted:!0}),e.jsx("canvas",{ref:l,className:"hidden"}),w&&e.jsx("p",{children:"Starting camera..."}),x&&e.jsx("p",{className:"p-4 text-center text-red-400",children:x}),!w&&!x&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-2/3 h-2/3 border-4 border-dashed border-white/50 rounded-lg"})})]}),e.jsxs("p",{className:"text-center mt-4 text-light-subtle dark:text-dark-subtle",children:[e.jsx(B,{className:"w-5 h-5 inline-block mr-2"}),"Point the camera at the student's ID card QR code."]})]}),v&&p&&m&&e.jsx($,{isOpen:v,onClose:P,student:p,classInfo:m,sale:D})]}):e.jsx("div",{className:"p-8 text-center",children:"Class not found."})};export{K as default};
