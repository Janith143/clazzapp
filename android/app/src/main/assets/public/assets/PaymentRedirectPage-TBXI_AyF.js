var F=Object.defineProperty,G=Object.defineProperties;var K=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var J=(l,t,n)=>t in l?F(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n,N=(l,t)=>{for(var n in t||(t={}))z.call(t,n)&&J(l,n,t[n]);if(I)for(var n of I(t))M.call(t,n)&&J(l,n,t[n]);return l},k=(l,t)=>G(l,K(t));var U=(l,t,n)=>new Promise((_,P)=>{var j=c=>{try{u(n.next(c))}catch(e){P(e)}},d=c=>{try{u(n.throw(c))}catch(e){P(e)}},u=c=>c.done?_(c.value):Promise.resolve(c.value).then(j,d);u((n=n.apply(l,t)).next())});import{r as D,u as B,j as s,L as R}from"./index-BXN-gaEy.js";import"./vendor-firebase-CLtQg3ae.js";const W=({user:l,payload:t})=>{const n=D.useRef(null),[_,P]=D.useState(null),[j,d]=D.useState(null),{paymentGatewaySettings:u,functionUrls:c}=B(),e=t.updatedUser||l;return D.useEffect(()=>{const A=()=>U(void 0,null,function*(){var C,L,v,E,$,O;let a,i,r,p,m={};const f=window.location.origin,S={first_name:(e==null?void 0:e.firstName)||"",last_name:(e==null?void 0:e.lastName)||"",email:(e==null?void 0:e.email)||"",contact_number:(e==null?void 0:e.contactNumber)||"0771234567",address_line_one:((C=e==null?void 0:e.address)==null?void 0:C.line1)||"N/A",address_line_two:((L=e==null?void 0:e.address)==null?void 0:L.line2)||"",city:((v=e==null?void 0:e.address)==null?void 0:v.city)||"N/A",state:((E=e==null?void 0:e.address)==null?void 0:E.state)||"",postal_code:(($=e==null?void 0:e.address)==null?void 0:$.postalCode)||"",country:((O=e==null?void 0:e.address)==null?void 0:O.country)||"Sri Lanka"};switch(t.type){case"enrollment":p={type:"enrollment",sale:t.sale,itemType:"lectures"in t.item?"course":"questions"in t.item?"quiz":"class",frontend_url:f},a=t.sale.id,i=t.item.title,r=t.sale.totalAmount,m=k(N({},S),{items:i});break;case"topup":p={type:"topup",amount:t.amount,frontend_url:f},a=`topup_${e==null?void 0:e.id}_${Date.now()}`,i="Account Top-Up",r=t.amount,m=k(N({},S),{items:i});break;case"voucher":p={type:"voucher",details:t.details,quantity:t.quantity,totalAmount:t.totalAmount,frontend_url:f},a=`voucher_${Date.now()}`,i=`${t.quantity} x Gift Voucher(s)`,r=t.totalAmount,m={first_name:t.details.billingFirstName,last_name:t.details.billingLastName,email:t.details.billingEmail,contact_number:t.details.billingContactNumber||"0771234567",address_line_one:t.details.billingAddressLineOne,address_line_two:t.details.billingAddressLineTwo||"",city:t.details.billingCity||"N/A",state:t.details.billingState||"",postal_code:t.details.billingPostalCode||"",country:t.details.billingCountry||"Sri Lanka",items:i};break;case"external_topup":p={type:"external_topup",students:t.students,amountPerStudent:t.amountPerStudent,totalAmount:t.totalAmount,billingDetails:t.billingDetails,frontend_url:f},a=`ext_topup_${Date.now()}`,i=`Account Top-Up for ${t.students.length} student(s)`,r=t.totalAmount,m={first_name:t.billingDetails.billingFirstName,last_name:t.billingDetails.billingLastName,email:t.billingDetails.billingEmail,contact_number:t.billingDetails.billingContactNumber||"0771234567",address_line_one:t.billingDetails.billingAddressLineOne,city:t.billingDetails.billingCity||"N/A",state:t.billingDetails.billingState||"",postal_code:t.billingDetails.billingPostalCode||"",country:t.billingDetails.billingCountry||"Sri Lanka",items:i};break;case"photo_purchase":case"marketplace_purchase":{const{cart:g,totalAmount:x,billingDetails:o}=t,h=g.map(y=>{var q;if(y.type==="product")return{type:"product",id:y.product.id,quantity:y.quantity};const b=y;return{type:b.type,id:b.photo.id,url_thumb:b.photo.url_thumb,url_highres:b.photo.url_highres,quantity:b.quantity,printOptionId:(q=b.printOption)==null?void 0:q.id,eventId:b.eventId,instituteId:b.instituteId}});p=k(N({},t),{cart:h,frontend_url:f}),a=`${t.type}_${Date.now()}`,i=`Purchase (${g.length} items)`,r=x,m={first_name:o.billingFirstName,last_name:o.billingLastName,email:o.billingEmail,contact_number:o.billingContactNumber||"0771234567",address_line_one:o.billingAddressLineOne,city:o.billingCity||"N/A",state:o.billingState||"",postal_code:o.billingPostalCode||"",country:o.billingCountry||"Sri Lanka",items:i};break}case"teacher_subscription":{p={type:"teacher_subscription",planLevel:t.planLevel,amount:t.amount,refCode:t.refCode,billingDetails:t.billingDetails,frontend_url:f},a=`sub_${t.planLevel}_${Date.now()}`,i=`Teacher Subscription - Plan ${t.planLevel}`,r=t.amount,m={first_name:t.billingDetails.billingFirstName,last_name:t.billingDetails.billingLastName,email:t.billingDetails.billingEmail,contact_number:t.billingDetails.billingContactNumber,address_line_one:"N/A",city:"N/A",country:"Sri Lanka",items:i};break}default:d("Invalid payment type.");return}if(r<=0&&t.type!=="enrollment"){d("Amount must be greater than zero for this transaction type.");return}const T=t.selectedMethod||"card";if((u.methodMapping[T]||u.activePaymentGateway)==="marxipg")try{const g=btoa(unescape(encodeURIComponent(JSON.stringify(p)))),x={order_id:a,amount:r,items:i,customer:{first_name:m.first_name,last_name:m.last_name,email:m.email,contact_number:m.contact_number},custom_fields:g,return_url:`${c.marxPayment}/marx-callback`,frontend_url:f},h=yield(yield fetch(`${c.marxPayment}/createOrder`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)})).json();if(h.success&&h.payUrl)window.location.href=h.payUrl;else throw new Error(h.message||"Failed to initiate Marx payment.")}catch(g){d(g.message)}else{const g=`${a}|${r.toFixed(2)}`,x=new window.JSEncrypt,o=u.gateways.webxpay.publicKey;if(!o){d("Payment configuration error: Missing Public Key.");return}x.setPublicKey(o);const h=x.encrypt(g);if(!h){console.error("Encryption failed! Plaintext:",g),d("Could not prepare payment data. Please try again.");return}const y=btoa(unescape(encodeURIComponent(JSON.stringify(p)))),b=k(N({},m),{secret_key:u.gateways.webxpay.secretKey,payment:h,process_currency:"LKR",cms:"React",return_url:`${c.payment}/payment-callback`,custom_fields:y,enc_method:"JCs3J+6oSz4V0LgE0zi/Bg=="});P(b)}}),w=(a=10,i=200)=>{if(window.JSEncrypt)try{const r=new window.JSEncrypt;if(r&&typeof r.setPublicKey=="function")A();else throw new Error("JSEncrypt object is invalid or missing methods.")}catch(r){console.error(`JSEncrypt instantiation failed. Retries left: ${a}`,r),a>0?setTimeout(()=>w(a-1,i),i):d("A required payment library failed to initialize. Please check your connection and try again.")}else a>0?setTimeout(()=>w(a-1,i),i):d("A required payment library failed to load. Please check your network connection and refresh the page.")};w()},[e,t,u]),D.useEffect(()=>{_&&n.current&&n.current.submit()},[_]),j?s.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-light-background dark:bg-dark-background",children:s.jsxs("div",{className:"text-center p-8 max-w-md",children:[s.jsx(R,{className:"h-16 w-16 mx-auto text-red-500"}),s.jsx("h1",{className:"text-2xl font-bold mt-4 text-red-600",children:"Payment Error"}),s.jsx("p",{className:"mt-2 text-light-subtle dark:text-dark-subtle",children:j}),s.jsx("button",{onClick:()=>window.history.back(),className:"mt-6 px-6 py-2 bg-primary text-white font-semibold rounded-md hover:bg-primary-dark",children:"Go Back"})]})}):s.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen bg-light-background dark:bg-dark-background",children:[s.jsxs("div",{className:"text-center p-8",children:[s.jsx(R,{className:"h-16 w-16 mx-auto text-primary animate-pulse"}),s.jsx("h1",{className:"text-2xl font-bold mt-4",children:"Preparing secure payment..."}),s.jsx("p",{className:"mt-2 text-light-subtle dark:text-dark-subtle",children:"You will be redirected automatically. Do not close this window."}),s.jsx("div",{className:"mt-8",children:s.jsx("div",{className:"w-16 h-16 border-4 border-dashed rounded-full animate-spin border-primary"})})]}),s.jsx("form",{ref:n,method:"post",action:u.gateways.webxpay.baseUrl||"https://webxpay.com/index.php?route=checkout/billing",style:{display:"none"},children:_&&Object.entries(_).map(([A,w])=>s.jsx("input",{type:"hidden",name:A,value:w},A))})]})};export{W as default};
