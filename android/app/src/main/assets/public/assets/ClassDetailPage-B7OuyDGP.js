import{b as V,u as K,e as J,d as q,r as l,aD as G,g as S,f as Q,j as t,S as W,C as X,M as Z,l as U,aa as ee,F as te}from"./index-BXN-gaEy.js";import{C as D}from"./Countdown-tuRDrQvi.js";import{S as se}from"./StarRating-BeOC4AZb.js";import{C as ae}from"./ConfirmationModal-CVK0Y9X0.js";import{P as ne}from"./PaymentMethodSelector-CJgtkeLh.js";import{S as re}from"./SEOHead-fOquVp0s.js";import{s as le}from"./slug-Be7lxzw5.js";import"./vendor-firebase-CLtQg3ae.js";const be=({classId:g,slug:p})=>{const{currentUser:a}=V(),{handleBack:M,handleNavigate:v}=K(),{setModalState:I,setVideoPlayerState:oe}=J(),{handleRateTeacher:T,handleEnroll:w,loading:R,teachers:b}=q(),P=l.useMemo(()=>{if(g)return g;if(p&&b.length>0)for(const s of b){const r=s.individualClasses.find(o=>le(o.title)===p);if(r)return r.id}return 0},[g,p,b]),{item:e,teacher:n,isEnrolled:d}=G("class",P||0),L=l.useMemo(()=>{if(!e||!n)return null;const s=e;return{"@context":"https://schema.org","@type":"Course",name:e.title,description:e.description,provider:{"@type":"Person",name:n.name,image:n.avatar||n.profileImage},offers:{"@type":"Offer",price:s.fee,priceCurrency:"LKR",availability:"https://schema.org/InStock",category:"Paid"}}},[e,n]),[E,f]=l.useState(!1),[O,y]=l.useState(!1),[ie,F]=l.useState(!1),C=l.useRef(null),i=l.useMemo(()=>e&&"endTime"in e?S(e):"scheduled",[e]),j=l.useMemo(()=>e&&"endTime"in e?Q(e):null,[e]),h=l.useMemo(()=>{if(!e||!("endTime"in e))return new Date;const s=e.recurrence==="weekly"?new Date().toISOString().split("T")[0]:e.date,[r,o]=e.endTime.split(":").map(Number),[u,x,H]=s.split("-").map(Number);return new Date(u,x-1,H,r,o,0,0)},[e]);l.useMemo(()=>{if(!e||!("endTime"in e)||!e.recordingUrls)return null;if(e.recurrence!=="weekly")return e.recordingUrls[e.date]||null;const s=Object.keys(e.recordingUrls);if(s.length===0)return null;const r=s.reduce((o,u)=>new Date(u)>new Date(o)?u:o);return e.recordingUrls[r]||null},[e]),l.useEffect(()=>{const s=r=>{C.current&&!C.current.contains(r.target)&&F(!1)};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[]);const A=l.useMemo(()=>{if(!a||!n||!e||!("endTime"in e)||a.role!=="student"||!d||S(e)!=="finished")return!1;const r=new Date(h.getTime()+60*60*1e3),o=new Date,u=n.ratings.some(x=>x.studentId===a.id&&x.classId===e.id);return o>h&&o<r&&!u},[a,d,e,n,h]);if(R)return t.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center flex flex-col items-center justify-center",children:[t.jsx(W,{className:"w-8 h-8 text-primary"}),t.jsx("p",{className:"mt-4 text-light-subtle dark:text-dark-subtle",children:"Loading class details..."})]});if(!e||!n||!("endTime"in e))return t.jsx("div",{children:"Class not found. It may have been removed by the teacher."});const B=()=>{a?f(!0):I({name:"login",preventRedirect:!0})},Y=()=>{const s=Math.min((a==null?void 0:a.accountBalance)||0,e.fee),r=e.fee-s,o=e.paymentMethod==="manual"&&e.fee>0;r>0&&!o?(y(!0),f(!1)):(w(e,"class"),f(!1))},_=s=>{w(e,"class",!1,void 0,void 0,void 0,s),y(!1)},$=s=>{s.username?v({name:"teacher_profile_slug",slug:s.username}):v({name:"teacher_profile",teacherId:s.id})},c=new Intl.NumberFormat("en-LK",{style:"currency",currency:"LKR"}),k=e.paymentMethod==="manual"&&e.fee>0,m=Math.min((a==null?void 0:a.accountBalance)||0,e.fee),N=e.fee-m;new Date(e.date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"});const z=()=>i==="canceled"?"Class Canceled":i==="finished"?"Class Finished":d?"You are enrolled":(a==null?void 0:a.role)==="teacher"||(a==null?void 0:a.role)==="admin"?"Only students can enroll":k?"Register Now (Free)":"Register Now";return t.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-slideInUp",children:[t.jsx(re,{title:e?e.title:"Class Details",description:e?e.description.substring(0,160):"View class details on clazz.lk",image:n?n.avatar||n.profileImage:void 0,structuredData:L}),t.jsx("div",{className:"mb-4",children:t.jsxs("button",{onClick:M,className:"flex items-center space-x-2 text-sm font-medium text-primary hover:text-primary-dark transition-colors",children:[t.jsx(X,{className:"h-5 w-5"}),t.jsx("span",{children:"Back"})]})}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[t.jsxs("div",{className:"lg:col-span-2 space-y-8",children:[t.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md",children:[t.jsx("span",{className:"px-3 py-1 text-sm font-semibold rounded-full bg-primary/10 text-primary-dark dark:text-primary-light uppercase tracking-wider",children:e.subject}),t.jsx("h1",{className:"mt-3 text-3xl md:text-4xl font-bold",children:e.title}),t.jsx("div",{className:"mt-2 text-light-subtle dark:text-dark-subtle",children:t.jsx(Z,{content:e.description,className:"prose-lg"})}),t.jsx("div",{className:"mt-6 flex items-center space-x-4",children:t.jsxs("button",{onClick:()=>$(n),className:"flex items-center space-x-2 group",children:[t.jsx("img",{src:U(n.avatar,40,40),alt:n.name,className:"w-10 h-10 rounded-full"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-light-subtle dark:text-dark-subtle",children:"Taught by"}),t.jsx("p",{className:"font-semibold group-hover:underline",children:n.name})]})]})})]}),A&&t.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md animate-fadeIn",children:[t.jsx("h3",{className:"text-xl font-bold mb-2",children:"How was your class?"}),t.jsxs("p",{className:"text-sm text-light-subtle dark:text-dark-subtle mb-4",children:["Rate your experience with ",n.name,". Your feedback is valuable!"]}),t.jsx(se,{rating:0,onRatingChange:s=>T(n.id,e.id,s),size:"lg"})]})]}),t.jsx("div",{className:"lg:col-span-1",children:t.jsxs("div",{className:"sticky top-24 bg-light-surface dark:bg-dark-surface rounded-lg shadow-md p-6 space-y-4",children:[i==="scheduled"&&j?t.jsxs("div",{className:"mb-6 pb-6 border-b border-light-border dark:border-dark-border",children:[t.jsx("h3",{className:"font-bold text-center text-lg mb-2",children:"Next Class Starts In"}),t.jsx(D,{targetDate:j,completionMessage:"Class is about to start!"})]}):i==="scheduled"&&!j?t.jsx("div",{className:"mb-6 pb-6 border-b border-light-border dark:border-dark-border",children:t.jsx("h3",{className:"font-bold text-center text-lg text-primary",children:"This recurring class series has ended."})}):null,i==="live"&&t.jsxs("div",{className:"mb-6 pb-6 border-b border-light-border dark:border-dark-border",children:[t.jsx("div",{className:"text-center",children:t.jsx("span",{className:"px-4 py-2 rounded-full bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-200 font-bold animate-pulse",children:"Live Now!"})}),t.jsx("h3",{className:"font-bold text-center text-lg mb-2 mt-4",children:"Class Finishes In"}),t.jsx(D,{targetDate:h,completionMessage:"Class has now ended."})]}),t.jsxs("div",{className:"text-left",children:[t.jsx("p",{className:"text-3xl font-bold text-primary",children:e.fee>0?c.format(e.fee):"Free"}),e.fee>0&&t.jsx("p",{className:"text-sm font-semibold text-light-subtle dark:text-dark-subtle",children:e.recurrence==="flexible"?"for all sessions":e.weeklyPaymentOption==="per_month"?"/ month":"/ session"})]}),a&&m>0&&!d&&!k&&(i==="scheduled"||i==="live")&&t.jsxs("div",{className:"mt-4 p-3 text-sm bg-green-50 dark:bg-green-900/50 border border-green-200 dark:border-green-800 rounded-md",children:[t.jsx("p",{className:"font-semibold text-green-800 dark:text-green-200",children:"Account Balance Applied!"}),t.jsxs("div",{className:"flex justify-between text-green-700 dark:text-green-300",children:[t.jsx("span",{children:"Balance Used:"}),t.jsxs("span",{children:["-",c.format(m)]})]}),t.jsxs("div",{className:"flex justify-between font-bold mt-1 pt-1 border-t border-green-300 dark:border-green-700",children:[t.jsx("span",{children:"Amount to Pay:"}),t.jsx("span",{children:c.format(N)})]})]}),t.jsxs("div",{className:"mt-4 space-y-2",children:[d&&i==="live"&&e.joiningLink&&t.jsx("a",{href:e.joiningLink,target:"_blank",rel:"noopener noreferrer",className:"w-full text-center block bg-green-600 text-white font-bold py-3 rounded-md hover:bg-green-700 transition-colors",children:"Join Class Now"}),t.jsx("button",{onClick:B,disabled:d||i!=="scheduled"&&i!=="live"||(a==null?void 0:a.role)==="teacher"||(a==null?void 0:a.role)==="admin",className:"w-full bg-primary text-white font-bold py-3 rounded-md hover:bg-primary-dark transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed",children:z()}),d&&e.documentLink&&t.jsxs("a",{href:e.documentLink,target:"_blank",rel:"noopener noreferrer",className:"w-full text-center flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition-colors",children:[t.jsx(ee,{className:"w-5 h-5"}),"View Class Documents"]})]})]})})]}),E&&(()=>{let s,r;return e.fee>0&&!k?(m>0?N>0?(s=`Your account balance of ${c.format(m)} will be applied. Continue to select a payment method for the remaining ${c.format(N)}?`,r="Continue to Payment"):(s=`Your account balance of ${c.format(m)} will fully cover the cost of this registration. Continue?`,r="Register using Balance"):(s=`You are about to pay ${c.format(e.fee)} to register for this class. Continue to select a payment method?`,r="Continue to Payment"),s+=" Please note that there will be no refunds for change of mind."):(s="Are you sure you want to register for this class?",r="Yes, Register"),t.jsx(ae,{isOpen:!0,onClose:()=>f(!1),onConfirm:Y,title:`Confirm Registration: ${e.title}`,message:s,confirmText:r})})(),O&&t.jsx(te,{isOpen:!0,onClose:()=>y(!1),title:"Select Payment Method",children:t.jsx(ne,{onSelect:_})})]})};export{be as default};
