import{j as e,l as L,y as J,b as U,u as W,e as Z,d as ee,r as m,aD as te,h as se,S as re,C as Q,M as ae,a6 as ne,O as ie}from"./index-BXN-gaEy.js";import{C as E}from"./Countdown-tuRDrQvi.js";import{C as de}from"./ConfirmationModal-CVK0Y9X0.js";import{u as le}from"./useSEO-BjUGcIuA.js";import{s as oe}from"./slug-Be7lxzw5.js";import"./vendor-firebase-CLtQg3ae.js";const B=({results:u,totalQuestions:b})=>{const w=i=>{const o=Math.floor(i/60),h=i%60;return`${o}m ${h}s`},r=["text-yellow-400","text-gray-400 dark:text-gray-300","text-yellow-600 dark:text-amber-700"];return e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Leaderboard"}),u.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-light-border dark:divide-dark-border",children:[e.jsx("thead",{className:"bg-light-background dark:bg-dark-background",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase tracking-wider w-16",children:"Rank"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase tracking-wider",children:"Student"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium uppercase tracking-wider",children:"Score"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium uppercase tracking-wider",children:"Time"})]})}),e.jsx("tbody",{className:"divide-y divide-light-border dark:divide-dark-border",children:u.map((i,o)=>{var h,f,k,z;return e.jsxs("tr",{className:o<3?"bg-primary/5 dark:bg-primary/10":"",children:[e.jsxs("td",{className:`px-4 py-3 whitespace-nowrap font-bold text-xl ${r[o]||"text-light-text dark:text-dark-text"}`,children:["#",o+1]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[i.studentAvatar?e.jsx("img",{className:"h-10 w-10 rounded-full",src:L(i.studentAvatar,40,40),alt:i.studentName,crossOrigin:"anonymous"}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary flex-shrink-0 flex items-center justify-center text-white text-base font-bold",children:e.jsxs("span",{children:[((f=(h=i.studentName)==null?void 0:h.split(" ")[0])==null?void 0:f.charAt(0))||"",((z=(k=i.studentName)==null?void 0:k.split(" ")[1])==null?void 0:z.charAt(0))||""]})}),e.jsx("div",{className:"ml-4",children:e.jsx("div",{className:"text-sm font-medium text-light-text dark:text-dark-text",children:i.studentName})})]})}),e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap text-right text-sm font-semibold",children:[i.score," / ",b]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-right text-sm text-light-subtle dark:text-dark-subtle",children:e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx(J,{className:"w-4 h-4 mr-1"}),w(i.timeTakenSeconds)]})})]},i.studentId)})})]})}):e.jsx("p",{className:"text-center py-8 text-light-subtle dark:text-dark-subtle",children:"No submissions yet. The leaderboard will appear here after the quiz ends."})]})},be=({quizId:u,instanceId:b,slug:w})=>{const{currentUser:r}=U(),{handleBack:i,handleNavigate:o}=W(),{setModalState:h}=Z(),{submissions:f,users:k,handleEnroll:z,sales:S,teachers:q,loading:F}=ee(),Y=m.useMemo(()=>{if(u)return u;if(w&&q.length>0)for(const s of q){const n=s.quizzes.find(j=>oe(j.title)===w);if(n)return n.id}return""},[u,w,q]),{item:y,teacher:l}=te("quiz",Y),[D,O]=m.useState(!1),[P,R]=m.useState(!1),t=m.useMemo(()=>{if(b&&r){const s=S.find(n=>n.studentId===r.id&&n.itemId===u&&n.itemType==="quiz"&&n.itemSnapshot.instanceStartDate===b);if(s)return s.itemSnapshot}return y},[b,y,S,r,u]),I=m.useMemo(()=>!r||!t||!("instanceStartDate"in t)?!1:(l==null?void 0:l.userId)===r.id?!0:S.some(s=>s.studentId===r.id&&s.itemId===t.id&&s.itemType==="quiz"&&s.status==="completed"&&s.itemSnapshot.instanceStartDate===t.instanceStartDate),[r,t,S,l]),g=m.useMemo(()=>!r||!t||!("instanceStartDate"in t)?null:f.find(s=>s.studentId===r.id&&s.quizId===t.id&&s.quizInstanceId===t.instanceStartDate),[r,f,t]);le(t?t.title:"Quiz Details",t?t.description.substring(0,160):"View quiz details on clazz.lk",l?l.profileImage:void 0);const x=m.useMemo(()=>t&&"questions"in t?se(t):"scheduled",[t]),_=m.useMemo(()=>t&&"durationMinutes"in t?new Date(new Date(`${t.date}T${t.startTime}`).getTime()+t.durationMinutes*6e4):new Date,[t]),M=m.useMemo(()=>{if(!t||!("questions"in t)||x!=="finished")return[];const s=t.instanceStartDate;return f.filter(a=>a.quizId===t.id&&a.quizInstanceId===s).map(a=>{const d=k.find(X=>X.id===a.studentId),T=new Date(`${t.date}T${t.startTime}`),v=new Date(a.submittedAt),N=Math.round((v.getTime()-T.getTime())/1e3);return{studentId:a.studentId,studentName:d?`${d.firstName} ${d.lastName}`:"Unknown Student",studentAvatar:(d==null?void 0:d.avatar)||"",score:a.score,timeTakenSeconds:N>0?N:Math.floor(Math.random()*t.durationMinutes*60)}}).sort((a,d)=>a.score!==d.score?d.score-a.score:a.timeTakenSeconds-d.timeTakenSeconds)},[x,t,f,k]);if(F)return e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-20 text-center flex flex-col items-center justify-center",children:[e.jsx(re,{className:"w-8 h-8 text-primary"}),e.jsx("p",{className:"mt-4 text-light-subtle dark:text-dark-subtle",children:"Loading quiz details..."})]});if(!t||!l||!("questions"in t))return e.jsx("div",{children:"Quiz not found. It may have been removed by the teacher."});const A=()=>{r?R(!0):h({name:"login",preventRedirect:!0})},V=()=>{y&&"questions"in y&&z(y,"quiz"),R(!1)},H=()=>o({name:"quiz_taking",quizId:t.id}),K=s=>{s.username?o({name:"teacher_profile_slug",slug:s.username}):o({name:"teacher_profile",teacherId:s.id})},c=new Intl.NumberFormat("en-LK",{style:"currency",currency:"LKR"}),$=new Date(`${t.date}T${t.startTime}`),p=Math.min((r==null?void 0:r.accountBalance)||0,t.fee),C=t.fee-p,G=()=>x==="canceled"?e.jsx("button",{disabled:!0,className:"w-full bg-gray-500 text-white font-bold py-3 rounded-md cursor-not-allowed",children:"Quiz Canceled"}):!I&&((r==null?void 0:r.role)==="teacher"||(r==null?void 0:r.role)==="admin")?e.jsx("button",{disabled:!0,className:"w-full bg-gray-500 text-white font-bold py-3 rounded-md cursor-not-allowed",children:"Only students can enroll"}):g?x!=="finished"?e.jsx("button",{disabled:!0,className:"w-full bg-gray-500 text-white font-bold py-3 rounded-md cursor-not-allowed",children:"Submitted"}):e.jsx("button",{onClick:()=>O(!D),className:"w-full bg-primary text-white font-bold py-3 rounded-md hover:bg-primary-dark",children:D?"Hide Answer Review":"Review Your Answers"}):x==="finished"?e.jsx("button",{disabled:!0,className:"w-full bg-gray-500 text-white font-bold py-3 rounded-md cursor-not-allowed",children:"Quiz has ended"}):new Date<$?I?e.jsx("button",{disabled:!0,className:"w-full bg-gray-500 text-white font-bold py-3 rounded-md cursor-not-allowed",children:"Enrolled"}):e.jsx("button",{onClick:A,className:"w-full bg-primary text-white font-bold py-3 rounded-md hover:bg-primary-dark",children:"Register Now"}):I&&!g?e.jsx("button",{onClick:H,className:"w-full bg-green-600 text-white font-bold py-3 rounded-md hover:bg-green-700 animate-pulse",children:"Start Quiz Now"}):r?e.jsx("button",{onClick:A,className:"w-full bg-primary text-white font-bold py-3 rounded-md hover:bg-primary-dark",children:"Register Now"}):e.jsx("button",{onClick:()=>h({name:"login",preventRedirect:!0}),className:"w-full bg-primary text-white font-bold py-3 rounded-md hover:bg-primary-dark",children:"Login to Register"});return e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-slideInUp",children:[e.jsx("div",{className:"mb-4",children:b?e.jsxs("button",{onClick:()=>o({name:"student_dashboard",initialTab:"quizzes"}),className:"flex items-center space-x-2 text-sm font-medium text-primary hover:text-primary-dark transition-colors",children:[e.jsx(Q,{className:"h-5 w-5"}),e.jsx("span",{children:"Back to My Quizzes"})]}):e.jsxs("button",{onClick:i,className:"flex items-center space-x-2 text-sm font-medium text-primary hover:text-primary-dark transition-colors",children:[e.jsx(Q,{className:"h-5 w-5"}),e.jsx("span",{children:"Back"})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-8",children:[e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md",children:[e.jsx("span",{className:"px-3 py-1 text-sm font-semibold rounded-full bg-primary/10 text-primary-dark dark:text-primary-light uppercase tracking-wider",children:t.subject}),e.jsx("h1",{className:"mt-3 text-3xl md:text-4xl font-bold",children:t.title}),e.jsx("div",{className:"mt-2 text-light-subtle dark:text-dark-subtle",children:e.jsx(ae,{content:t.description,className:"prose-lg"})}),e.jsx("div",{className:"mt-6 flex items-center space-x-4",children:e.jsxs("button",{onClick:()=>K(l),className:"flex items-center space-x-2 group",children:[e.jsx("img",{src:L(l.avatar,40,40),alt:l.name,className:"w-10 h-10 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-light-subtle dark:text-dark-subtle",children:"Hosted by"}),e.jsx("p",{className:"font-semibold group-hover:underline",children:l.name})]})]})})]}),g?x!=="finished"?e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Submission Received!"}),e.jsx("p",{className:"text-light-subtle dark:text-dark-subtle mb-6",children:"Results, leaderboard, and the answer review will be available after the quiz officially ends."}),e.jsx("h3",{className:"font-bold text-lg mb-2",children:"Quiz Ends In"}),e.jsx("div",{className:"flex justify-center",children:e.jsx(E,{targetDate:_,completionMessage:"The quiz has ended!"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Your Result"}),e.jsxs("div",{className:"flex justify-around text-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-light-subtle dark:text-dark-subtle",children:"Score"}),e.jsxs("p",{className:"text-3xl font-bold text-primary",children:[g.score,"/",t.questions.length]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-light-subtle dark:text-dark-subtle",children:"Rank"}),e.jsxs("p",{className:"text-3xl font-bold text-primary",children:["#",M.findIndex(s=>s.studentId===(r==null?void 0:r.id))+1||"N/A"]})]})]})]}),D&&e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Answer Review"}),t.questions.map((s,n)=>{const j=g.answers.find(a=>a.questionId===s.id);return e.jsxs("div",{className:"p-4 border border-light-border dark:border-dark-border rounded-md",children:[s.imageUrl&&e.jsx("div",{className:"mb-4 rounded-lg overflow-hidden",children:e.jsx("img",{src:s.imageUrl,alt:"Question visual aid",className:"max-h-60 w-auto mx-auto"})}),e.jsxs("p",{className:"font-semibold",children:[n+1,". ",s.text]}),e.jsx("div",{className:"mt-3 space-y-2",children:s.answers.map(a=>{const d=j==null?void 0:j.selectedAnswerIds.includes(a.id),T=a.isCorrect;let v=null,N="";return d&&!T?(v=e.jsx(ne,{className:"w-5 h-5 text-red-500 mr-2"}),N="bg-red-50 dark:bg-red-900/30 border-l-4 border-red-500"):T&&(v=e.jsx(ie,{className:"w-5 h-5 text-green-500 mr-2"}),N="bg-green-50 dark:bg-green-900/30 border-l-4 border-green-500"),e.jsxs("div",{className:`flex items-center p-3 rounded-md ${N}`,children:[v,e.jsx("p",{className:`${d?"font-bold":""}`,children:a.text})]},a.id)})})]},s.id)})]}),e.jsx(B,{results:M,totalQuestions:t.questions.length})]}):x==="finished"?e.jsx(B,{results:M,totalQuestions:t.questions.length}):e.jsxs("div",{className:"bg-light-surface dark:bg-dark-surface p-6 rounded-lg shadow-md text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Ready to test your knowledge?"}),e.jsx("p",{className:"text-light-subtle dark:text-dark-subtle",children:"Register and start the quiz before the time runs out. Good luck!"})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"sticky top-24 bg-light-surface dark:bg-dark-surface rounded-lg shadow-md p-6 space-y-4",children:[x==="scheduled"&&new Date<$&&!g&&e.jsxs("div",{className:"pb-4 border-b border-light-border dark:border-dark-border",children:[e.jsx("h3",{className:"font-bold text-center text-lg mb-2",children:"Quiz Starts In"}),e.jsx(E,{targetDate:$,completionMessage:"Quiz is starting now!"})]}),e.jsx("p",{className:"text-3xl font-bold text-primary",children:t.fee>0?c.format(t.fee):"Free"}),r&&p>0&&!I&&t.status==="scheduled"&&e.jsxs("div",{className:"mt-4 p-3 text-sm bg-green-50 dark:bg-green-900/50 border border-green-200 dark:border-green-800 rounded-md",children:[e.jsx("p",{className:"font-semibold text-green-800 dark:text-green-200",children:"Account Balance Applied!"}),e.jsxs("div",{className:"flex justify-between text-green-700 dark:text-green-300",children:[e.jsx("span",{children:"Balance Used:"}),e.jsxs("span",{children:["-",c.format(p)]})]}),e.jsxs("div",{className:"flex justify-between font-bold mt-1 pt-1 border-t border-green-300 dark:border-green-700",children:[e.jsx("span",{children:"Amount to Pay:"}),e.jsx("span",{children:c.format(C)})]})]}),G()]})})]}),P&&(()=>{let s,n;return t.fee>0?(p>0?C>0?(s=`Your account balance of ${c.format(p)} will be applied. You are about to pay the remaining ${c.format(C)}. Continue?`,n=`Pay ${c.format(C)}`):(s=`Your account balance of ${c.format(p)} will fully cover the cost of this registration. Continue?`,n="Register using Balance"):(s=`You are about to pay ${c.format(t.fee)} to register for this quiz. Continue?`,n=`Pay ${c.format(t.fee)}`),s+=" Please note that there will be no refunds for change of mind."):(s="Are you sure you want to register for this quiz?",n="Yes, Register"),e.jsx(de,{isOpen:!0,onClose:()=>R(!1),onConfirm:V,title:`Confirm Registration: ${t.title}`,message:s,confirmText:n})})()]})};export{be as default};
